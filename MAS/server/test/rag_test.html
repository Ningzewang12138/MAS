<!DOCTYPE html>
<html>
<head>
    <title>RAG Chat Test</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .main {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
        }
        button:hover {
            background-color: #0056b3;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #chatMessages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .user-message {
            background-color: #e3f2fd;
            text-align: right;
        }
        .assistant-message {
            background-color: #f5f5f5;
        }
        .search-results {
            background-color: #fff3cd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .error {
            color: red;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 4px;
            margin: 10px 0;
        }
        h3 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>RAG Chat Test Interface</h1>
    
    <div class="container">
        <div class="sidebar">
            <h3>Knowledge Base</h3>
            
            <label>Select Knowledge Base:</label>
            <select id="kbSelect">
                <option value="">-- Select KB --</option>
            </select>
            <button onclick="refreshKBList()">Refresh</button>
            
            <hr>
            
            <h4>Create New KB</h4>
            <input type="text" id="newKBName" placeholder="KB Name">
            <textarea id="newKBDesc" placeholder="Description" rows="3"></textarea>
            <button onclick="createKB()">Create</button>
            
            <hr>
            
            <h4>Add Document</h4>
            <textarea id="docContent" placeholder="Document content..." rows="5"></textarea>
            <button onclick="addDocument()">Add to KB</button>
            
            <h4>Upload File</h4>
            <input type="file" id="fileInput" accept=".txt,.md,.pdf,.docx">
            <button onclick="uploadFile()">Upload</button>
            
            <div id="status"></div>
        </div>
        
        <div class="main">
            <h3>RAG Chat</h3>
            
            <div id="chatMessages"></div>
            
            <div style="display: flex; gap: 10px;">
                <input type="text" id="userInput" placeholder="Ask a question..." style="flex: 1;">
                <button onclick="sendMessage()" style="width: auto;">Send</button>
            </div>
            
            <div style="margin-top: 10px;">
                <label>
                    <input type="checkbox" id="useRAG" checked> Use RAG
                </label>
                <label style="margin-left: 20px;">
                    Search Limit: <input type="number" id="searchLimit" value="5" min="1" max="20" style="width: 50px;">
                </label>
            </div>
        </div>
    </div>

    <script>
        let selectedKB = null;
        
        // 页面加载时刷新知识库列表
        window.onload = function() {
            refreshKBList();
        };
        
        async function refreshKBList() {
            try {
                const response = await fetch('http://localhost:8000/api/knowledge/');
                const kbs = await response.json();
                
                const select = document.getElementById('kbSelect');
                select.innerHTML = '<option value="">-- Select KB --</option>';
                
                kbs.forEach(kb => {
                    const option = document.createElement('option');
                    option.value = kb.id;
                    option.textContent = `${kb.name} (${kb.document_count} docs)`;
                    select.appendChild(option);
                    });
               
               showStatus('Knowledge bases refreshed', 'success');
           } catch (error) {
               showStatus('Error refreshing KB list: ' + error.message, 'error');
           }
       }
       
       async function createKB() {
           const name = document.getElementById('newKBName').value;
           const description = document.getElementById('newKBDesc').value;
           
           if (!name) {
               showStatus('Please enter a name', 'error');
               return;
           }
           
           try {
               const response = await fetch('http://localhost:8000/api/knowledge/', {
                   method: 'POST',
                   headers: {'Content-Type': 'application/json'},
                   body: JSON.stringify({name, description})
               });
               
               if (response.ok) {
                   const kb = await response.json();
                   showStatus(`Created KB: ${kb.name}`, 'success');
                   document.getElementById('newKBName').value = '';
                   document.getElementById('newKBDesc').value = '';
                   await refreshKBList();
               } else {
                   const error = await response.json();
                   showStatus('Error: ' + error.detail, 'error');
               }
           } catch (error) {
               showStatus('Error creating KB: ' + error.message, 'error');
           }
       }
       
       async function addDocument() {
           const content = document.getElementById('docContent').value;
           const kbId = document.getElementById('kbSelect').value;
           
           if (!kbId) {
               showStatus('Please select a knowledge base', 'error');
               return;
           }
           
           if (!content) {
               showStatus('Please enter document content', 'error');
               return;
           }
           
           try {
               const response = await fetch(`http://localhost:8000/api/knowledge/${kbId}/documents`, {
                   method: 'POST',
                   headers: {'Content-Type': 'application/json'},
                   body: JSON.stringify({
                       content: content,
                       metadata: {source: 'manual_input', timestamp: new Date().toISOString()}
                   })
               });
               
               if (response.ok) {
                   const result = await response.json();
                   showStatus(`Added document with ${result.chunk_count} chunks`, 'success');
                   document.getElementById('docContent').value = '';
                   await refreshKBList();
               } else {
                   const error = await response.json();
                   showStatus('Error: ' + error.detail, 'error');
               }
           } catch (error) {
               showStatus('Error adding document: ' + error.message, 'error');
           }
       }
       
       async function uploadFile() {
           const fileInput = document.getElementById('fileInput');
           const kbId = document.getElementById('kbSelect').value;
           
           if (!kbId) {
               showStatus('Please select a knowledge base', 'error');
               return;
           }
           
           if (!fileInput.files[0]) {
               showStatus('Please select a file', 'error');
               return;
           }
           
           const formData = new FormData();
           formData.append('file', fileInput.files[0]);
           
           try {
               showStatus('Uploading file...', 'success');
               const response = await fetch(`http://localhost:8000/api/knowledge/${kbId}/documents/upload`, {
                   method: 'POST',
                   body: formData
               });
               
               if (response.ok) {
                   const result = await response.json();
                   showStatus(`Uploaded ${result.filename}: ${result.chunk_count} chunks, ${result.total_characters} chars`, 'success');
                   fileInput.value = '';
                   await refreshKBList();
               } else {
                   const error = await response.json();
                   showStatus('Error: ' + error.detail, 'error');
               }
           } catch (error) {
               showStatus('Error uploading file: ' + error.message, 'error');
           }
       }
       
       async function sendMessage() {
           const input = document.getElementById('userInput');
           const message = input.value.trim();
           
           if (!message) return;
           
           const useRAG = document.getElementById('useRAG').checked;
           const kbId = document.getElementById('kbSelect').value;
           const searchLimit = parseInt(document.getElementById('searchLimit').value);
           
           if (useRAG && !kbId) {
               showStatus('Please select a knowledge base for RAG', 'error');
               return;
           }
           
           // 添加用户消息到聊天
           addMessageToChat('user', message);
           input.value = '';
           
           try {
               let url, body;
               
               if (useRAG) {
                   url = 'http://localhost:8000/api/chat/rag/completions';
                   body = {
                       knowledge_base_id: kbId,
                       messages: [{role: 'user', content: message}],
                       stream: false,
                       search_limit: searchLimit
                   };
               } else {
                   url = 'http://localhost:8000/api/chat/completions';
                   body = {
                       messages: [{role: 'user', content: message}],
                       stream: false
                   };
               }
               
               const response = await fetch(url, {
                   method: 'POST',
                   headers: {'Content-Type': 'application/json'},
                   body: JSON.stringify(body)
               });
               
               if (response.ok) {
                   const data = await response.json();
                   
                   // 如果有搜索结果，显示它们
                   if (data.search_results) {
                       addSearchResultsToChat(data.search_results);
                   }
                   
                   // 添加助手回复
                   const assistantMessage = data.choices[0].message.content;
                   addMessageToChat('assistant', assistantMessage);
               } else {
                   const error = await response.json();
                   addMessageToChat('error', 'Error: ' + error.detail);
               }
           } catch (error) {
               addMessageToChat('error', 'Error: ' + error.message);
           }
       }
       
       function addMessageToChat(role, content) {
           const chatMessages = document.getElementById('chatMessages');
           const messageDiv = document.createElement('div');
           messageDiv.className = `message ${role}-message`;
           
           if (role === 'error') {
               messageDiv.className = 'error';
           }
           
           messageDiv.textContent = content;
           chatMessages.appendChild(messageDiv);
           chatMessages.scrollTop = chatMessages.scrollHeight;
       }
       
       function addSearchResultsToChat(searchResults) {
           const chatMessages = document.getElementById('chatMessages');
           const resultsDiv = document.createElement('div');
           resultsDiv.className = 'search-results';
           
           let html = `<strong>Found ${searchResults.count} relevant documents:</strong><br>`;
           searchResults.documents.forEach((doc, i) => {
               html += `${i + 1}. ${doc.content}<br>`;
           });
           
           resultsDiv.innerHTML = html;
           chatMessages.appendChild(resultsDiv);
           chatMessages.scrollTop = chatMessages.scrollHeight;
       }
       
       function showStatus(message, type) {
           const status = document.getElementById('status');
           status.className = type;
           status.textContent = message;
           
           setTimeout(() => {
               status.textContent = '';
               status.className = '';
           }, 5000);
       }
       
       // Enter键发送消息
       document.getElementById('userInput').addEventListener('keypress', function(e) {
           if (e.key === 'Enter') {
               sendMessage();
           }
       });
   </script>
</body>
</html>