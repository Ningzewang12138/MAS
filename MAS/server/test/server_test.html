<!DOCTYPE html>
<html>
<head>
    <title>Chat API Test</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #response {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            margin-top: 10px;
            padding: 5px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .model-info {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Multi-Agent System Chat Test</h1>
        
        <div class="model-info">
            <strong>Model Status:</strong>
            <span id="modelStatus">Loading...</span>
            <button onclick="refreshModels()">Refresh Models</button>
        </div>
        
        <div>
            <label>API URL:</label>
            <input type="text" id="apiUrl" value="http://localhost:8000/api/chat/completions" />
        </div>
        
        <div>
            <label>Model:</label>
            <select id="model">
                <option value="">Auto (Use Default)</option>
            </select>
        </div>
        
        <div>
            <label>Message:</label>
            <textarea id="message" rows="3">你好，请用一句话介绍自己</textarea>
        </div>
        
        <button onclick="testChat(false)">Test Chat (Non-Stream)</button>
        <button onclick="testChat(true)">Test Chat (Stream)</button>
        <button onclick="testHealth()">Test Health</button>
        
        <div id="status" class="status" style="display:none;"></div>
        <div id="response"></div>
    </div>

    <script>
        // 页面加载时获取模型列表
        window.onload = function() {
            refreshModels();
        };
        
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + (isError ? 'error' : 'success');
            statusEl.style.display = 'block';
        }
        
        async function refreshModels() {
            try {
                // 获取模型列表
                const response = await fetch('http://localhost:8000/api/chat/models');
                const data = await response.json();
                
                const modelSelect = document.getElementById('model');
                const modelStatus = document.getElementById('modelStatus');
                
                // 清空现有选项（除了 Auto）
                modelSelect.innerHTML = '<option value="">Auto (Use Default)</option>';
                
                if (data.data && data.data.length > 0) {
                    modelStatus.textContent = `${data.data.length} models available. Default: ${data.default_model}`;
                    
                    // 添加模型选项
                    data.data.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = model.name + (model.is_default ? ' (default)' : '');
                        modelSelect.appendChild(option);
                    });
                } else {
                    modelStatus.textContent = 'No models available';
                }
                
                // 刷新模型列表
                await fetch('http://localhost:8000/api/chat/refresh-models', {
                    method: 'POST'
                });
                
            } catch (error) {
                document.getElementById('modelStatus').textContent = 'Error loading models: ' + error.message;
            }
        }

        async function testChat(stream = false) {
            const apiUrl = document.getElementById('apiUrl').value;
            const model = document.getElementById('model').value;
            const message = document.getElementById('message').value;
            const responseEl = document.getElementById('response');
            
            responseEl.textContent = 'Sending request...';
            showStatus('Sending request...');
            
            const requestBody = {
                messages: [{
                    role: 'user',
                    content: message
                }],
                stream: stream
            };
            
            // 只有在明确选择了模型时才添加 model 字段
            if (model) {
                requestBody.model = model;
            }
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.detail || 'Unknown error'}`);
                }
                
                if (stream) {
                    responseEl.textContent = 'Streaming response:\n\n';
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                
                                try {
                                    const json = JSON.parse(data);
                                    if (json.content) {
                                        responseEl.textContent += json.content;
                                    }
                                } catch (e) {
                                    // Ignore parse errors
                                }
                            }
                        }
                    }
                    showStatus('Stream completed successfully!');
                } else {
                    const data = await response.json();
                    responseEl.textContent = JSON.stringify(data, null, 2);
                    
                    // 显示使用的模型
                    if (data.model) {
                        showStatus(`Request completed successfully! Used model: ${data.model}`);
                    } else {
                        showStatus('Request completed successfully!');
                    }
                }
            } catch (error) {
                responseEl.textContent = 'Error: ' + error.message;
                showStatus('Error: ' + error.message, true);
            }
        }
        
        async function testHealth() {
            const responseEl = document.getElementById('response');
            try {
                const response = await fetch('http://localhost:8000/api/system/health');
                const data = await response.json();
                responseEl.textContent = JSON.stringify(data, null, 2);
                showStatus('Health check completed!');
            } catch (error) {
                responseEl.textContent = 'Error: ' + error.message;
                showStatus('Error: ' + error.message, true);
            }
        }
    </script>
</body>
</html>