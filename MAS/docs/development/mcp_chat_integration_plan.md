# MCP与聊天API集成开发计划

## 项目现状分析

### 已有功能
1. **聊天API** (`/api/chat/completions`)
   - 支持流式和非流式响应
   - 支持模型选择（包括自动选择）
   - OpenAI兼容的API格式
   - RAG增强聊天功能

2. **MCP服务** (`/api/mcp/*`)
   - 工具注册和管理系统
   - 工具执行框架
   - 工作空间管理
   - 支持文件系统、网络、数据处理、地图等工具类别

### 需要集成的部分
目前聊天API和MCP服务是独立的，需要将它们集成，使聊天功能能够调用MCP工具。

## 开发计划

### 第一阶段：聊天API支持工具调用（优先级：高）

#### 1.1 扩展聊天请求模型
- 在 `ChatRequest` 中添加 `tools` 和 `tool_choice` 字段（已有定义但未使用）
- 支持OpenAI格式的工具定义

#### 1.2 实现工具调用决策
- 在聊天处理逻辑中，检测是否需要调用工具
- 解析LLM返回的工具调用请求
- 支持自动工具选择（tool_choice="auto"）

#### 1.3 工具执行集成
- 调用MCP管理器执行工具
- 处理工具执行结果
- 将结果反馈给LLM生成最终响应

#### 1.4 响应格式支持
- 支持包含工具调用的响应格式
- 流式响应中的工具调用事件

### 第二阶段：工作空间集成（优先级：中）

#### 2.1 会话级工作空间
- 为每个聊天会话创建独立工作空间
- 自动管理工作空间生命周期

#### 2.2 文件处理集成
- 支持在聊天中上传文件到工作空间
- 工具可以访问会话工作空间中的文件
- 聊天响应可以引用工作空间中生成的文件

### 第三阶段：高级功能（优先级：低）

#### 3.1 多轮工具调用
- 支持在一次对话中多次调用工具
- 工具调用链的管理

#### 3.2 并行工具执行
- 支持同时执行多个独立的工具调用
- 优化响应时间

#### 3.3 工具调用历史
- 记录工具调用历史
- 支持查询和分析工具使用情况

## 实施细节

### 1. 修改 `chat.py`

```python
# 在 ChatRequest 中激活已有的工具相关字段
# 添加工具调用处理逻辑

async def chat_completions_with_tools(
    request: Request,
    chat_request: ChatRequest,
    ollama: OllamaService = Depends(get_ollama_service)
):
    # 1. 检查是否提供了工具
    if chat_request.tools:
        # 2. 将工具定义添加到系统提示
        # 3. 调用LLM获取响应
        # 4. 解析工具调用
        # 5. 执行工具
        # 6. 将结果反馈给LLM
        # 7. 返回最终响应
```

### 2. 创建工具调用中间件

```python
# server/services/tool_call_service.py
class ToolCallService:
    def __init__(self, mcp_manager):
        self.mcp_manager = mcp_manager
    
    async def process_tool_calls(self, llm_response, session_id):
        # 解析和执行工具调用
        pass
```

### 3. 集成流程

```
用户消息 → 聊天API → LLM（带工具定义） → 工具调用决策
    ↓                                          ↓
    ↓                                    MCP工具执行
    ↓                                          ↓
最终响应 ← LLM（带工具结果） ← 工具执行结果
```

## 测试计划

### 1. 单元测试
- 工具调用解析测试
- 工具执行测试
- 响应格式测试

### 2. 集成测试
- 端到端的聊天+工具调用测试
- 多轮对话测试
- 错误处理测试

### 3. 性能测试
- 工具调用延迟测试
- 并发处理测试

## 时间估算

- 第一阶段：2-3天
- 第二阶段：1-2天
- 第三阶段：2-3天
- 测试和优化：2天

总计：约1-2周完成全部功能

## 风险和注意事项

1. **模型兼容性**：不同的Ollama模型对工具调用的支持程度可能不同
2. **性能影响**：工具调用会增加响应延迟
3. **安全性**：需要确保工具调用的安全性，避免恶意使用
4. **错误处理**：需要完善的错误处理机制

## 下一步行动

1. **选项A**：开始实施第一阶段，修改chat.py支持基础的工具调用
2. **选项B**：先创建详细的API设计文档，包括请求/响应格式示例
